<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Clase ‚Äì Musicala</title>
  <style>
    body { font-family: "Inter", sans-serif; background: #f7f9fc; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 30px auto; padding: 24px 24px 32px; background: #fff; border-radius: 24px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08); }
    h1 { text-align: center; color: #0C41C4; margin: 0 0 30px; font-size: 28px; }
    .row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 240px; }
    label { font-size: 14px; font-weight: 600; color: #111827; }
    input, select, textarea, button { width: 100%; padding: 10px 12px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 14px; margin-top: 6px; outline: none; transition: border-color 0.15s, box-shadow 0.15s; }
    input:focus, select:focus, textarea:focus { border-color: #0C41C4; box-shadow: 0 0 0 1px rgba(12, 65, 196, 0.25); }
    textarea { height: 110px; border-radius: 18px; resize: vertical; }
    button { background: #0C41C4; color: white; font-weight: 600; cursor: pointer; border: none; border-radius: 999px; padding: 12px 18px; margin-top: 28px; }
    button:hover { background: #08349a; }
    .status { margin-top: 16px; font-size: 14px; text-align: center; color: #DC2626; }

    /* MULTI CHECKBOX UI */
    .multi-box { margin-top: 6px; background: #f9fafb; border-radius: 18px; border: 1px solid #e5e7eb; padding: 8px 10px; }
    .multi-search { border-radius: 999px; border: 1px solid transparent; background: white; padding: 7px 10px; margin-bottom: 6px; font-size: 13px; }
    .multi-search:focus { border-color: #0C41C4; box-shadow: 0 0 0 1px rgba(12, 65, 196, 0.2); outline: none; }
    .checkbox-list { max-height: 150px; overflow-y: auto; padding-right: 4px; }
    .check-item { display: flex; align-items: center; gap: 8px; padding: 4px 4px; border-radius: 12px; cursor: pointer; font-size: 13px; color: #111827; }
    .check-item:hover { background: #e5e7eb; }
    .check-item input[type="checkbox"] { width: 16px; height: 16px; border-radius: 4px; cursor: pointer; }
    .chips { margin-top: 4px; display: flex; flex-wrap: wrap; gap: 6px; font-size: 11px; }
    .chip { background: #e0ecff; color: #1d4ed8; padding: 2px 8px; border-radius: 999px; white-space: nowrap; }
    .help-text { font-size: 11px; color: #6b7280; margin-top: 4px; }

    .file-input { border-radius: 999px; background: #f9fafb; }

    @media (max-width: 640px) {
      .container { margin: 16px; padding: 18px 16px 24px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Registro de Clase ‚Äì Musicala</h1>

    <!-- FECHA Y DOCENTE -->
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="fecha" type="date" />
      </div>
      <div>
        <label>Docente</label>
        <select id="docente">
          <option>Cargando...</option>
        </select>
      </div>
    </div>

    <!-- ESTUDIANTES (MULTI) + CATEGOR√çAS -->
    <div class="row">
      <div>
        <label>Estudiante</label>
        <div class="multi-box">
          <input
            type="text"
            id="filtro-estudiantes"
            class="multi-search"
            placeholder="Escribe para filtrar estudiantes..."
            oninput="filtrarCheckboxes('filtro-estudiantes','lista-estudiantes')"
          />
          <div id="lista-estudiantes" class="checkbox-list"></div>
          <div id="chips-estudiantes" class="chips"></div>
          <div class="help-text">Puedes seleccionar varios estudiantes.</div>
        </div>
      </div>

      <!-- CATEGOR√çAS -->
      <div>
        <label>Categor√≠as</label>
        <div class="multi-box">
          <input
            type="text"
            id="filtro-categorias"
            class="multi-search"
            placeholder="Escribe para filtrar..."
            oninput="filtrarCheckboxes('filtro-categorias','lista-categorias')"
          />
          <div id="lista-categorias" class="checkbox-list"></div>
          <div id="chips-categorias" class="chips"></div>
          <div class="help-text">Puedes seleccionar varias categor√≠as.</div>
        </div>
      </div>
    </div>

    <!-- TAREAS -->
    <div>
      <label>Tareas / Observaciones</label>
      <textarea id="tareasObs" placeholder="Logros, dificultades, acuerdos, tareas..."></textarea>
    </div>

    <!-- COMPONENTES -->
    <div class="row">
      <div>
        <label>Componente corporal</label>
        <div class="multi-box">
          <input type="text" id="filtro-corporal" class="multi-search" placeholder="Escribe para filtrar..." oninput="filtrarCheckboxes('filtro-corporal','lista-corporal')" />
          <div id="lista-corporal" class="checkbox-list"></div>
          <div id="chips-corporal" class="chips"></div>
        </div>
      </div>
      <div>
        <label>Componente t√©cnico</label>
        <div class="multi-box">
          <input type="text" id="filtro-tecnico" class="multi-search" placeholder="Escribe para filtrar..." oninput="filtrarCheckboxes('filtro-tecnico','lista-tecnico')" />
          <div id="lista-tecnico" class="checkbox-list"></div>
          <div id="chips-tecnico" class="chips"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Componente te√≥rico</label>
        <div class="multi-box">
          <input type="text" id="filtro-teorico" class="multi-search" placeholder="Escribe para filtrar..." oninput="filtrarCheckboxes('filtro-teorico','lista-teorico')" />
          <div id="lista-teorico" class="checkbox-list"></div>
          <div id="chips-teorico" class="chips"></div>
        </div>
      </div>
      <div>
        <label>Componente de obras</label>
        <div class="multi-box">
          <input type="text" id="filtro-obras" class="multi-search" placeholder="Escribe para filtrar..." oninput="filtrarCheckboxes('filtro-obras','lista-obras')" />
          <div id="lista-obras" class="checkbox-list"></div>
          <div id="chips-obras" class="chips"></div>
        </div>
      </div>
    </div>

    <!-- ARCHIVOS -->
    <div class="row">
      <div>
        <label>Archivos / Im√°genes (opcional)</label>
        <input id="imagenFile" class="file-input" type="file" accept="image/*, application/pdf" />
      </div>
      <div>
        <label>Videos (opcional)</label>
        <input id="videoFile" class="file-input" type="file" accept="video/*" />
      </div>
    </div>

    <button onclick="enviarRegistro()">Enviar registro</button>
    <div class="status" id="status"></div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb_d9d4vvXuEAEAHq7fyV3CFAZQlXGnBH0BoaGTDysodL-nQleWleNCMrpENpjZQxjkg/exec"; // <--- CAMBIA ESTO

    /****************************************************
     * Cargar listas desde Apps Script
     ****************************************************/
    async function cargarListas() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=options`);
        const data = await res.json();

        cargarSelect("docente", data.docentes);

        // ‚úÖ Estudiantes ahora van a lista de checkboxes multi
        cargarCheckboxList("lista-estudiantes", data.estudiantes);

        cargarCheckboxList("lista-categorias", data.categorias);
        cargarCheckboxList("lista-corporal", data.corporal);
        cargarCheckboxList("lista-tecnico", data.tecnico);
        cargarCheckboxList("lista-teorico", data.teorico);
        cargarCheckboxList("lista-obras", data.obras);

        // Render inicial chips (vac√≠o)
        actualizarChips();

      } catch (e) {
        document.getElementById("status").textContent = "‚ö† No se pudieron cargar las listas.";
      }
    }

    /****************************************************
     * Select normal (pero con placeholder en DOCENTE)
     ****************************************************/
    function cargarSelect(id, lista) {
      const select = document.getElementById(id);
      select.innerHTML = "";

      if (id === "docente") {
        const placeholder = document.createElement("option");
        placeholder.textContent = "Selecciona un docente";
        placeholder.value = "";
        placeholder.disabled = true;
        placeholder.selected = true;
        placeholder.hidden = true;
        select.appendChild(placeholder);
      }

      (lista || []).forEach(item => {
        const opt = document.createElement("option");
        opt.textContent = item;
        opt.value = item;
        select.appendChild(opt);
      });
    }

    /****************************************************
     * Crear lista de checkboxes
     ****************************************************/
    function cargarCheckboxList(containerId, lista) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = "";

      (lista || []).forEach(item => {
        const label = document.createElement("label");
        label.className = "check-item";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = item;
        input.addEventListener("change", actualizarChips);

        const span = document.createElement("span");
        span.textContent = item;

        label.appendChild(input);
        label.appendChild(span);
        cont.appendChild(label);
      });
    }

    /****************************************************
     * Filtros
     ****************************************************/
    function filtrarCheckboxes(inputId, containerId) {
      const filtro = document.getElementById(inputId).value.toLowerCase();
      const cont = document.getElementById(containerId);

      Array.from(cont.children).forEach(label => {
        const texto = label.textContent.toLowerCase();
        label.style.display = texto.includes(filtro) ? "flex" : "none";
      });
    }

    /****************************************************
     * Chips resumen (incluye estudiantes)
     ****************************************************/
    function actualizarChips() {
      const grupos = [
        ["lista-estudiantes", "chips-estudiantes"],
        ["lista-categorias", "chips-categorias"],
        ["lista-corporal", "chips-corporal"],
        ["lista-tecnico", "chips-tecnico"],
        ["lista-teorico", "chips-teorico"],
        ["lista-obras", "chips-obras"]
      ];

      grupos.forEach(([listaId, chipsId]) => {
        const cont = document.getElementById(listaId);
        const chipsBox = document.getElementById(chipsId);
        chipsBox.innerHTML = "";

        Array.from(cont.querySelectorAll("input:checked"))
          .map(chk => chk.value)
          .forEach(val => {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = val;
            chipsBox.appendChild(chip);
          });
      });
    }

    /****************************************************
     * Convertir archivos a Base64
     ****************************************************/
    function fileToBase64(file) {
      return new Promise(resolve => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve({
          base64: reader.result.split(",")[1],
          name: file.name,
          type: file.type
        });
        reader.readAsDataURL(file);
      });
    }

    /****************************************************
     * Limpiar formulario
     ****************************************************/
    function limpiarFormulario() {
      document.getElementById("fecha").value = "";
      document.getElementById("docente").selectedIndex = 0;

      // ‚úÖ limpiar estudiantes multi
      document.getElementById("filtro-estudiantes").value = "";
      document.querySelectorAll(`#lista-estudiantes input[type="checkbox"]`)
        .forEach(chk => chk.checked = false);

      document.getElementById("tareasObs").value = "";

      ["lista-categorias","lista-corporal","lista-tecnico","lista-teorico","lista-obras"]
        .forEach(id => {
          document.querySelectorAll(`#${id} input[type="checkbox"]`)
            .forEach(chk => chk.checked = false);
        });

      ["chips-estudiantes","chips-categorias","chips-corporal","chips-tecnico","chips-teorico","chips-obras"]
        .forEach(id => document.getElementById(id).innerHTML = "");

      ["filtro-categorias","filtro-corporal","filtro-tecnico","filtro-teorico","filtro-obras"]
        .forEach(id => document.getElementById(id).value = "");

      document.getElementById("imagenFile").value = "";
      document.getElementById("videoFile").value = "";
    }

    /****************************************************
     * Enviar registro
     ****************************************************/
    async function enviarRegistro() {
      document.getElementById("status").textContent = "Enviando registro...";

      const imagen = await fileToBase64(document.getElementById("imagenFile").files[0]);
      const video  = await fileToBase64(document.getElementById("videoFile").files[0]);

      // ‚úÖ estudiantes seleccionados como string "A, B, C" (igual que categor√≠as)
      const estudiantesSeleccionados = obtenerSeleccionados("lista-estudiantes");

      const payload = {
        fecha: document.getElementById("fecha").value,
        docente: document.getElementById("docente").value,

        // üëá mantenemos el mismo nombre de campo para no romper Apps Script
        estudiante: estudiantesSeleccionados,

        tareasObs: document.getElementById("tareasObs").value,

        categorias: obtenerSeleccionados("lista-categorias"),
        corporal: obtenerSeleccionados("lista-corporal"),
        tecnico: obtenerSeleccionados("lista-tecnico"),
        teorico: obtenerSeleccionados("lista-teorico"),
        obras: obtenerSeleccionados("lista-obras"),

        imagenBase64: imagen?.base64 || "",
        imagenName:   imagen?.name   || "",
        imagenType:   imagen?.type   || "",

        videoBase64:  video?.base64  || "",
        videoName:    video?.name    || "",
        videoType:    video?.type    || ""
      };

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (data.ok) {
          document.getElementById("status").textContent = "‚úî Registro enviado con √©xito.";
          limpiarFormulario();
        } else {
          document.getElementById("status").textContent = "‚ö† Error: " + (data.error || "");
        }
      } catch (err) {
        document.getElementById("status").textContent = "‚ùå Error al enviar. Verifica permisos.";
      }
    }

    function obtenerSeleccionados(listaId) {
      return Array.from(
        document.querySelectorAll(`#${listaId} input[type="checkbox"]:checked`)
      ).map(chk => chk.value).join(", ");
    }

    cargarListas();
  </script>
</body>
</html>